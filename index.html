<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Russell's Toys â€” Pages Browser</title>
    <style>
        :root{--bg:#0f1724;--panel:#0b1220;--muted:#9aa4b2;--accent:#60a5fa;--card:#0e1722}
        html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#071026);color:#dbeafe;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
        .app{display:flex;height:100vh;gap:18px;padding:18px;box-sizing:border-box}
        .sidebar{width:360px;background:linear-gradient(180deg,var(--panel),#07111a);border-radius:10px;padding:14px;box-shadow:0 6px 20px rgba(2,6,23,.6);display:flex;flex-direction:column;gap:10px}
        header{display:flex;align-items:center;gap:12px}
        header h1{font-size:16px;margin:0}
        .controls{display:flex;gap:8px;align-items:center;margin-left:auto}
        input[type="search"]{flex:1;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
        .list{overflow:auto;flex:1;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
        .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;margin:6px 2px;cursor:pointer}
        .item:hover{background:rgba(255,255,255,0.02)}
        .meta{font-size:12px;color:var(--muted)}
        .badge{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px}
        .main{flex:1;display:flex;flex-direction:column;gap:12px}
        .viewer{flex:1;background:var(--card);border-radius:10px;overflow:hidden;box-shadow:0 6px 40px rgba(2,6,23,.6);display:flex;flex-direction:column}
        iframe{border:0;width:100%;height:100%}
        pre{white-space:pre-wrap;word-break:break-word;padding:16px;margin:0;overflow:auto;height:100%;background:transparent;color:#e6eef8}
        .toolbar{display:flex;align-items:center;gap:8px;padding:12px;border-bottom:1px solid rgba(255,255,255,0.02)}
        button{background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit;padding:8px 10px;border-radius:8px;cursor:pointer}
        .crumbs{font-size:13px;color:var(--muted);display:flex;gap:6px;flex-wrap:wrap}
        .hidden{display:none}
        @media (max-width:900px){.sidebar{width:100%;height:360px;flex:none}.app{flex-direction:column;padding:12px}}
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar" aria-label="Pages directory">
            <header>
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden>
                    <rect width="24" height="24" rx="6" fill="#0b1220"></rect>
                    <path d="M7 8h10M7 12h10M7 16h6" stroke="#60a5fa" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div>
                    <h1>Russell's Toys</h1>
                    <div class="meta">Browse pages/ directory</div>
                </div>
                <div class="controls">
                    <button id="homeBtn" title="Go to /pages/">Home</button>
                    <button id="reloadBtn" title="Reload current">Reload</button>
                </div>
            </header>

            <div style="display:flex;gap:8px">
                <input id="search" type="search" placeholder="Filter files (name or extension)" />
                <select id="filterExt" title="Filter by extension" aria-label="Filter by extension">
                    <option value="">All</option>
                    <option>.html</option>
                    <option>.md</option>
                    <option>.txt</option>
                    <option>.json</option>
                    <option>.css</option>
                    <option>.js</option>
                </select>
            </div>

            <div class="crumbs" id="breadcrumbs" style="padding:6px 2px"></div>

            <div class="list" id="listing" role="list" aria-label="Directory listing">
                <!-- generated -->
            </div>
        </aside>

        <main class="main">
            <div class="viewer">
                <div class="toolbar">
                    <div id="currentPath" class="meta" style="flex:1">/pages/</div>
                    <div id="fileInfo" class="meta"></div>
                </div>
                <div id="content" style="flex:1;position:relative">
                    <!-- file viewer (iframe or pre) inserted here -->
                    <div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)">Select a file or folder from the left to view</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // GitHub Copilot
        (function(){
            const root = '/pages/';
            let currentPath = root;

            const listingEl = document.getElementById('listing');
            const contentEl = document.getElementById('content');
            const breadcrumbsEl = document.getElementById('breadcrumbs');
            const currentPathEl = document.getElementById('currentPath');
            const fileInfoEl = document.getElementById('fileInfo');
            const searchEl = document.getElementById('search');
            const filterExtEl = document.getElementById('filterExt');
            const homeBtn = document.getElementById('homeBtn');
            const reloadBtn = document.getElementById('reloadBtn');

            homeBtn.addEventListener('click', ()=> navigateTo(root));
            reloadBtn.addEventListener('click', ()=> loadPath(currentPath));
            searchEl.addEventListener('input', ()=> renderItems(latestItems));
            filterExtEl.addEventListener('change', ()=> renderItems(latestItems));
            window.addEventListener('popstate', e => {
                const p = (e.state && e.state.path) || root;
                navigateTo(p, {push:false});
            });

            // Keep the most recent items for filtering
            let latestItems = [];

            function setStatus(text){
                fileInfoEl.textContent = text || '';
            }

            function navigateTo(path, opts={push:true}){
                if(!path.endsWith('/')) path = path;
                currentPath = path;
                if(opts.push !== false) history.pushState({path}, '', path === root ? '/' : '#'+encodeURIComponent(path));
                currentPathEl.textContent = path;
                setStatus('');
                loadPath(path);
                renderBreadcrumbs(path);
            }

            function renderBreadcrumbs(path){
                breadcrumbsEl.innerHTML = '';
                const parts = path.replace(/^\/+|\/+$/g,'').split('/');
                let acc = '';
                const frag = document.createDocumentFragment();
                // root
                const rootBtn = document.createElement('button');
                rootBtn.textContent = '/';
                rootBtn.style.background = 'transparent';
                rootBtn.style.border = 'none';
                rootBtn.style.color = 'var(--muted)';
                rootBtn.style.cursor = 'pointer';
                rootBtn.addEventListener('click', ()=> navigateTo(root));
                frag.appendChild(rootBtn);
                if(parts[0] !== 'pages') {
                    // if path doesn't start with pages, still show
                }
                acc = '/';
                for(let i=1;i<parts.length;i++){
                    const btn = document.createElement('button');
                    acc += parts[i] + '/';
                    btn.textContent = parts[i];
                    btn.style.background='transparent';
                    btn.style.border='none';
                    btn.style.color='var(--muted)';
                    btn.style.cursor='pointer';
                    btn.addEventListener('click', ()=> navigateTo(acc));
                    frag.appendChild(document.createTextNode(' / '));
                    frag.appendChild(btn);
                }
                breadcrumbsEl.appendChild(frag);
            }

            async function loadPath(path){
                // Try to fetch the URL. If it's a directory listing, parse links.
                // If it's a file, display it.
                setListingLoading();
                try{
                    let url = path;
                    // Ensure trailing slash for directory attempts
                    if(!url.endsWith('/') && url.endsWith('/')){} // no-op
                    // First try directory URL (ensure slash)
                    const dirUrl = path.endsWith('/') ? path : path + '/';
                    let res = await fetch(dirUrl, {cache:'no-store'});
                    if(res.ok){
                        const ctype = res.headers.get('content-type') || '';
                        if(res.url.endsWith('/') || dirUrl !== res.url){
                            // server responded with directory content or redirect - treat as directory listing
                        }
                        // If content-type is html and contains links, parse anchors
                        const text = await res.text();
                        const anchors = parseAnchors(text, dirUrl);
                        if(anchors.length > 0){
                            latestItems = normalizeAnchors(anchors, dirUrl);
                            renderItems(latestItems);
                            setStatus(`${latestItems.length} item(s)`);
                            return;
                        }
                        // If we didn't find anchors, maybe it's an index.html file content => show as file
                        // continue to try fetching the exact path (no slash)
                    } else {
                        // directory fetch failed, try file fetch
                    }

                    // Try to fetch as file
                    res = await fetch(path, {cache:'no-store'});
                    if(!res.ok) throw new Error('Not found: ' + path);
                    const ctype = res.headers.get('content-type') || '';
                    if(ctype.includes('text/html')){
                        showIframe(path);
                        setStatus('HTML');
                    } else if(ctype.includes('application/javascript') || path.endsWith('.js')){
                        showText(await res.text(), 'javascript');
                        setStatus('JS');
                    } else if(ctype.includes('css') || path.endsWith('.css')){
                        showText(await res.text(), 'css');
                        setStatus('CSS');
                    } else if(ctype.includes('json') || path.endsWith('.json')){
                        const raw = await res.text();
                        try { const j = JSON.parse(raw); showText(JSON.stringify(j,null,2), 'json'); } catch(e){ showText(raw,'json'); }
                        setStatus('JSON');
                    } else if(ctype.includes('text/') || /\.(md|txt|csv|log)$/i.test(path)){
                        showText(await res.text(), 'text');
                        setStatus('Text');
                    } else {
                        // Binary or unknown - show in iframe fallback
                        showIframe(path);
                        setStatus('Binary/Other');
                    }
                } catch(err){
                    listingEl.innerHTML = '<div class="meta" style="padding:12px">Unable to load: '+(err.message||err)+'</div>';
                    contentEl.innerHTML = '<div style="padding:16px;color:var(--muted)">No preview available.</div>';
                    setStatus('Error');
                }
            }

            function setListingLoading(){
                listingEl.innerHTML = '<div class="meta" style="padding:12px">Loadingâ€¦</div>';
            }

            function parseAnchors(htmlText, baseUrl){
                const doc = new DOMParser().parseFromString(htmlText, 'text/html');
                const anchors = Array.from(doc.querySelectorAll('a[href]'));
                // Filter out parent link and anchors that navigate outside
                return anchors
                    .map(a => ({href: a.getAttribute('href'), text: a.textContent.trim()}))
                    .filter(a => a.href && !a.href.startsWith('mailto:') && !a.href.startsWith('#'));
            }

            function normalizeAnchors(anchorList, baseUrl){
                const u = new URL(baseUrl, location.origin);
                return anchorList.map(a => {
                    const href = a.href;
                    let full;
                    try{
                        full = new URL(href, u).toString();
                    }catch(e){
                        full = href;
                    }
                    // Only include links under /pages/
                    const relative = full.replace(location.origin, '');
                    return {
                        name: a.text || relative.split('/').pop() || relative,
                        href: relative,
                        full,
                        isDir: relative.endsWith('/')
                    };
                }).filter(item => item.href.startsWith('/pages/'));
            }

            function renderItems(items){
                const q = (searchEl.value || '').toLowerCase().trim();
                const ext = (filterExtEl.value || '').toLowerCase().trim();
                const filtered = items.filter(it => {
                    if(q){
                        if(!(it.name.toLowerCase().includes(q) || it.href.toLowerCase().includes(q))) return false;
                    }
                    if(ext){
                        return it.href.toLowerCase().endsWith(ext);
                    }
                    return true;
                }).sort((a,b)=>{
                    if(a.isDir !== b.isDir) return a.isDir ? -1 : 1;
                    return a.name.localeCompare(b.name);
                });

                listingEl.innerHTML = '';
                if(filtered.length === 0){
                    listingEl.innerHTML = '<div class="meta" style="padding:12px">No items</div>';
                    return;
                }

                for(const it of filtered){
                    const el = document.createElement('div');
                    el.className = 'item';
                    const left = document.createElement('div');
                    left.style.display='flex';
                    left.style.flexDirection='column';
                    const title = document.createElement('div');
                    title.textContent = it.name;
                    title.style.fontWeight='600';
                    const meta = document.createElement('div');
                    meta.className='meta';
                    meta.textContent = it.href.replace('/pages/','');
                    left.appendChild(title);
                    left.appendChild(meta);

                    const right = document.createElement('div');
                    right.style.display='flex';
                    right.style.alignItems='center';
                    right.style.gap='8px';
                    const badge = document.createElement('div');
                    badge.className='badge';
                    badge.textContent = it.isDir ? 'dir' : (getExt(it.href) || 'file');
                    right.appendChild(badge);

                    el.appendChild(left);
                    el.appendChild(right);
                    el.addEventListener('click', (e)=>{
                        if(it.isDir){
                            navigateTo(it.href.endsWith('/') ? it.href : it.href + '/');
                        } else {
                            navigateTo(it.href);
                        }
                    });
                    listingEl.appendChild(el);
                }
            }

            function getExt(path){
                const m = path.match(/\.([a-z0-9]+)(?:[?#]|$)/i);
                return m ? '.'+m[1].toLowerCase() : '';
            }

            function showIframe(path){
                contentEl.innerHTML = '';
                const iframe = document.createElement('iframe');
                iframe.src = path;
                iframe.title = path;
                contentEl.appendChild(iframe);
            }

            function showText(text, lang){
                contentEl.innerHTML = '';
                const pre = document.createElement('pre');
                pre.textContent = text;
                contentEl.appendChild(pre);
            }

            // Initial load: try to use server directory listing or optional index.json
            (async function init(){
                // If there's an index.json in /pages/, prefer that for stable listing
                try{
                    const idx = await fetch(root + 'index.json', {cache:'no-store'});
                    if(idx.ok){
                        const arr = await idx.json();
                        // index.json expected to be array of {path,name,isDir}
                        latestItems = (Array.isArray(arr) ? arr : []).map(i=>{
                            return {
                                name: i.name || i.path.split('/').pop(),
                                href: i.path.startsWith('/') ? i.path : '/pages/' + i.path.replace(/^\/+/, ''),
                                isDir: !!i.isDir
                            };
                        });
                        renderItems(latestItems);
                        navigateTo(root, {push:false});
                        return;
                    }
                }catch(e){ /* ignore */ }

                // fallback to parsing default directory listing
                navigateTo(root, {push:false});
            })();

        })();
    </script>
</body>
</html>